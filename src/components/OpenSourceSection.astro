---
import { siteConfig } from '../data/site';
---

<section class="section opensource-section" id="opensource">
  <div class="section-content">
    <h2 class="section-title">Open Source</h2>
    <p class="section-subtitle">Recent contributions</p>
    <div class="contributions-container" id="contributionsContainer">
      <div class="loading-state">
        <span class="loading-spinner"></span>
        <span>Loading contributions...</span>
      </div>
    </div>
    <p class="opensource-note">Just getting started.</p>
  </div>
</section>

<script define:vars={{ githubUsername: siteConfig.github.username }}>
  // Fetch GitHub contributions
  async function fetchContributions() {
    const container = document.getElementById('contributionsContainer');
    
    try {
      // Fetch PRs directly for merged status
      const searchResponse = await fetch(
        `https://api.github.com/search/issues?q=author:${githubUsername}+type:pr+is:merged+-user:${githubUsername}&sort=updated&per_page=10`
      );
      
      let mergedPRs = [];
      if (searchResponse.ok) {
        const searchData = await searchResponse.json();
        mergedPRs = searchData.items || [];
      }

      if (mergedPRs.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p>Starting my open source journey.</p>
            <p class="empty-hint">Contributions coming soon...</p>
          </div>
        `;
        return;
      }

      // Render merged PRs
      const contributions = mergedPRs.slice(0, 5).map(pr => {
        const repoName = pr.repository_url.split('/').slice(-2).join('/');
        const timeAgo = getTimeAgo(new Date(pr.closed_at));
        
        return `
          <a href="${pr.html_url}" target="_blank" class="contribution-card">
            <div class="contrib-repo">
              <svg class="repo-icon" viewBox="0 0 16 16" fill="currentColor">
                <path d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z"/>
              </svg>
              <span>${repoName}</span>
            </div>
            <p class="contrib-title">${pr.title}</p>
            <div class="contrib-meta">
              <span class="contrib-status merged">
                <svg viewBox="0 0 16 16" fill="currentColor">
                  <path d="M5.45 5.154A4.25 4.25 0 0 0 9.25 7.5h1.378a2.251 2.251 0 1 1 0 1.5H9.25A5.734 5.734 0 0 1 5 7.123v3.505a2.25 2.25 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.95-.218zM4.25 13.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5zm8.5-4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5zM5 3.25a.75.75 0 1 0 0 .005V3.25z"/>
                </svg>
                merged
              </span>
              <span class="contrib-time">${timeAgo}</span>
            </div>
          </a>
        `;
      }).join('');

      container.innerHTML = contributions;
      
    } catch (error) {
      container.innerHTML = `
        <div class="empty-state">
          <p>Starting my open source journey.</p>
          <p class="empty-hint">Contributions coming soon...</p>
        </div>
      `;
    }
  }

  function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    const intervals = {
      year: 31536000,
      month: 2592000,
      week: 604800,
      day: 86400,
      hour: 3600,
      minute: 60
    };
    
    for (const [unit, secondsInUnit] of Object.entries(intervals)) {
      const interval = Math.floor(seconds / secondsInUnit);
      if (interval >= 1) {
        return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
      }
    }
    return 'just now';
  }

  // Fetch on load
  fetchContributions();
</script>
