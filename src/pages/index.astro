---
import '../styles/global.css';
import { siteConfig, experience } from '../data/site';

// Components
import StickyNav from '../components/StickyNav.astro';
import Toast from '../components/Toast.astro';
import HeroSection from '../components/HeroSection.astro';
import ExperienceSection from '../components/ExperienceSection.astro';
import OpenSourceSection from '../components/OpenSourceSection.astro';
import EducationSection from '../components/EducationSection.astro';
import Footer from '../components/Footer.astro';
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{siteConfig.name} — {siteConfig.title}</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content={siteConfig.description} />
    <meta name="author" content={siteConfig.name} />
    <meta name="keywords" content="software engineer, full stack developer, TypeScript, AWS, React Native, Node.js" />
    
    <!-- Open Graph / Social Sharing -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={`${siteConfig.name} — ${siteConfig.title}`} />
    <meta property="og:description" content={siteConfig.description} />
    <meta property="og:image" content="/og-image.png" />
    <meta property="og:url" content={siteConfig.url} />
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${siteConfig.name} — ${siteConfig.title}`} />
    <meta name="twitter:description" content={siteConfig.description} />
    <meta name="twitter:image" content="/og-image.png" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    
    <!-- Preload critical assets -->
    <link rel="preload" href="/profile_pic.jpeg" as="image" />
    <link rel="preload" href="/terros1_logo.jpeg" as="image" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  </head>
  <body class="loading">
    <StickyNav />
    <Toast />

    <main class="scroll-container">
      <HeroSection />
      <ExperienceSection />
      <OpenSourceSection />
      <EducationSection />
      <Footer />
    </main>

    <script define:vars={{ experience, email: siteConfig.email }}>
      // Page load animation
      window.addEventListener('load', () => {
        document.body.classList.remove('loading');
        document.body.classList.add('loaded');
      });

      // Sticky nav section highlighting
      const sections = document.querySelectorAll('.section');
      const navLinks = document.querySelectorAll('.nav-link');
      const stickyNav = document.getElementById('stickyNav');
      
      // Intersection Observer for section highlighting
      const observerOptions = {
        root: null,
        rootMargin: '-50% 0px -50% 0px',
        threshold: 0
      };

      const sectionObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const sectionId = entry.target.id;
            navLinks.forEach(link => {
              link.classList.toggle('active', link.dataset.section === sectionId);
            });
          }
        });
      }, observerOptions);

      sections.forEach(section => sectionObserver.observe(section));

      // Hide/show nav based on hero section
      const heroObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          stickyNav.classList.toggle('visible', !entry.isIntersecting);
        });
      }, { threshold: 0.5 });

      heroObserver.observe(document.getElementById('hero'));

      // Smooth scroll for nav links
      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = link.getAttribute('href').slice(1);
          document.getElementById(targetId)?.scrollIntoView({ behavior: 'smooth' });
        });
      });

      // Experience Carousel
      const carouselTrack = document.getElementById('carouselTrack');
      const dots = document.querySelectorAll('.carousel-dot');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      let currentIndex = 0;

      function updateCarousel(index) {
        currentIndex = index;
        const cards = carouselTrack.querySelectorAll('.experience-card');
        cards.forEach((card, i) => {
          card.classList.toggle('active', i === index);
        });
        dots.forEach((dot, i) => {
          dot.classList.toggle('active', i === index);
        });
        
        // Update button states
        prevBtn.style.opacity = index === 0 ? '0.3' : '1';
        prevBtn.style.pointerEvents = index === 0 ? 'none' : 'auto';
        nextBtn.style.opacity = index === experience.length - 1 ? '0.3' : '1';
        nextBtn.style.pointerEvents = index === experience.length - 1 ? 'none' : 'auto';
      }

      prevBtn?.addEventListener('click', () => {
        if (currentIndex > 0) updateCarousel(currentIndex - 1);
      });

      nextBtn?.addEventListener('click', () => {
        if (currentIndex < experience.length - 1) updateCarousel(currentIndex + 1);
      });

      dots.forEach(dot => {
        dot.addEventListener('click', () => {
          updateCarousel(parseInt(dot.dataset.index));
        });
      });

      // Keyboard navigation for carousel
      document.addEventListener('keydown', (e) => {
        const experienceSection = document.getElementById('experience');
        const rect = experienceSection.getBoundingClientRect();
        const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
        
        if (!isVisible) return;
        
        if (e.key === 'ArrowLeft' && currentIndex > 0) {
          updateCarousel(currentIndex - 1);
        } else if (e.key === 'ArrowRight' && currentIndex < experience.length - 1) {
          updateCarousel(currentIndex + 1);
        }
      });

      // Touch/swipe for carousel
      let touchStartX = 0;
      carouselTrack?.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      carouselTrack?.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].screenX;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > 50) {
          if (diff > 0 && currentIndex < experience.length - 1) {
            updateCarousel(currentIndex + 1);
          } else if (diff < 0 && currentIndex > 0) {
            updateCarousel(currentIndex - 1);
          }
        }
      }, { passive: true });

      // Initialize carousel
      updateCarousel(0);

      // Email copy to clipboard + toast
      const emailBtns = document.querySelectorAll('.email-btn');
      const toast = document.getElementById('toast');
      let toastTimeout;

      function showToast() {
        if (toastTimeout) {
          clearTimeout(toastTimeout);
        }
        
        toast.classList.add('visible');
        
        toastTimeout = setTimeout(() => {
          toast.classList.remove('visible');
        }, 2000);
      }

      emailBtns.forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(email);
            showToast();
          } catch (err) {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = email;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast();
          }
        });
      });
    </script>
  </body>
</html>
